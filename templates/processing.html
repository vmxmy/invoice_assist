{% extends "base.html" %}

{% block title %}处理中 - 发票下载器{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">发票处理中</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <h2 class="card-title">正在处理发票</h2>
            <div class="text-center my-5">
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <h4 id="progress-text">正在连接邮箱...</h4>
                <p id="current-file" class="text-muted"></p>
            </div>
            <div class="alert alert-info">
                <p class="mb-0">请耐心等待，处理完成后将自动跳转到结果页面。</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 处理进度更新函数
    function updateProgress() {
        fetch('/process_status')
            .then(response => response.json())
            .then(data => {
                // 更新进度条
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const currentFile = document.getElementById('current-file');
                
                if (data.status === 'processing') {
                    // 计算进度百分比
                    const percent = (data.current / data.total) * 100;
                    progressBar.style.width = percent + '%';
                    progressBar.setAttribute('aria-valuenow', percent);
                    
                    // 更新文本
                    progressText.textContent = `正在处理第 ${data.current} / ${data.total} 张发票`;
                    
                    if (data.current_file) {
                        currentFile.textContent = `当前文件: ${data.current_file}`;
                    }
                    
                    // 继续轮询
                    setTimeout(updateProgress, 1000);
                } else if (data.status === 'complete') {
                    // 处理完成，跳转到结果页面
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', 100);
                    progressText.textContent = '处理完成，正在跳转...';
                    
                    // 跳转到结果页面
                    window.location.href = data.redirect_url;
                } else if (data.status === 'error') {
                    // 处理出错
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressText.textContent = '处理出错: ' + data.error;
                    
                    // 添加返回按钮
                    const card = document.querySelector('.card');
                    const button = document.createElement('div');
                    button.className = 'text-center mt-3';
                    button.innerHTML = '<a href="/download_invoices" class="btn btn-primary">返回导入页面</a>';
                    card.appendChild(button);
                } else {
                    // 继续轮询
                    setTimeout(updateProgress, 1000);
                }
            })
            .catch(error => {
                console.error('获取进度信息失败:', error);
                // 出错时继续轮询
                setTimeout(updateProgress, 2000);
            });
    }
    
    // 页面加载完成后开始轮询进度
    document.addEventListener('DOMContentLoaded', function() {
        updateProgress();
    });
</script>
{% endblock %} 